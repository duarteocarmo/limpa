{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Remove ads from your podcast">
        <title>Limpa</title>
        <link rel="stylesheet" href="{% static 'limpa/reset.css' %}">
        <link rel="stylesheet" href="{% static 'limpa/style.css' %}">
        <link rel="icon"
              href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§¼</text></svg>">
            <script src="https://unpkg.com/htmx.org@2.0.4"></script>
        </head>
        <body>
            <div class="container">
                <header>
                    <a href="/" class="logo">ðŸ§¼ Limpa</a>
                    <div class="tagline">Remove ads from your podcast feeds.</div>
                </header>
                <form class="form-row"
                      hx-post="{% url 'add_podcast' %}"
                      hx-target="#podcast-list"
                      hx-swap="afterbegin"
                      hx-indicator="#add-indicator"
                      hx-trigger="submit"
                      hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('empty-state')?.remove(); } else { alert(event.detail.xhr.responseText.replace(/<[^>]*>/g, '')); }">
                    {% csrf_token %}
                    <input type="url"
                           name="url"
                           placeholder="Podcast feed URL..."
                           required
                           autofocus>
                    <button type="submit">
                        <span class="btn-text">Add feed</span>
                        <span id="add-indicator" class="htmx-indicator">Processing...</span>
                    </button>
                </form>
                <p class="meta">
                    <a href="https://duarteocarmo.com" target="_blank">By Duarte O.Carmo</a> |
                    <a href="https://github.com/duarteocarmo/limpa" target="_blank">Source</a>
                </p>
                <hr>
                <div id="podcast-list" class="podcast-list">
                    {% for podcast in podcasts %}
                        {% partial podcast_item %}
                    {% empty %}
                        <div id="empty-state" class="empty-state">No podcasts added yet. Add one above!</div>
                    {% endfor %}
                </div>
            </div>
            <script>
            document.body.addEventListener('htmx:configRequest', (event) => {
                event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
            });
            </script>
        </body>
    </html>
    {% partialdef podcast_item %}
    <div class="podcast-item" id="podcast-{{ podcast.id }}">
        <div class="podcast-header">
            <div class="podcast-title">{{ podcast.title }}</div>
            <div class="podcast-actions">
                <button class="btn-delete"
                        hx-delete="{% url 'delete_podcast' podcast.id %}"
                        hx-target="#podcast-{{ podcast.id }}"
                        hx-swap="outerHTML"
                        hx-confirm="Remove this podcast?">x</button>
            </div>
        </div>
        {% partial podcast_stats %}
        <div class="podcast-feeds">
            <button class="btn-copy"
                    onclick="navigator.clipboard.writeText('{{ podcast.url }}').then(() => { this.textContent = 'âœ“ copied'; setTimeout(() => this.textContent = 'original rss', 1000); })"
                    title="Copy original feed URL">original rss</button>
            <button class="btn-copy"
                    onclick="navigator.clipboard.writeText('{{ request.scheme }}://{{ request.get_host }}{% url 'serve_feed' podcast.url_hash %}').then(() => { this.textContent = 'âœ“ copied'; setTimeout(() => this.textContent = 'modified rss', 1000); })"
                    title="Copy processed feed URL">modified rss</button>
            {% if podcast.last_refreshed_at %}
                <span class="timestamp">updated {{ podcast.last_refreshed_at|date:"M j, H:i" }}</span>
            {% endif %}
        </div>
    </div>
{% endpartialdef %}
{% partialdef error_message %}
<div class="error">{{ message }}</div>
{% endpartialdef %}
{% partialdef podcast_stats %}
<div class="podcast-meta"
     hx-get="{% url 'podcast_stats' podcast.id %}"
     hx-trigger="every 5s"
     hx-swap="outerHTML">
    <span class="status status-{{ podcast.status }}">{{ podcast.status }}</span>
    <span class="episode-count">{{ podcast.episode_count }} episode{{ podcast.episode_count|pluralize }}</span>
    <span class="processed-count">{{ podcast.processed_episodes|length }} processed</span>
    <span class="ads-count">{{ podcast.total_ads }} ad{{ podcast.total_ads|pluralize }} removed</span>
</div>
{% endpartialdef %}
